# 工作流的名称，在GitHub Actions面板中显示的名称
name: Windows RDP Server
# 工作流的触发方式配置
on:
  # 仅支持【手动触发】，在GitHub项目的Actions页面点击Run workflow启动，无自动触发规则
  workflow_dispatch:

# 定义任务集合，一个jobs可以有多个任务，此处只有1个核心任务
jobs:
  # 任务的自定义名称，标识该任务为安全的RDP远程服务部署
  secure-rdp:
    # 核心修改1：指定运行环境为 GitHub官方的 Windows Server 2016 镜像
    runs-on: windows-2016
    # 设置任务最长运行超时时间：3600分钟 = 60小时，超时后GitHub强制终止云服务器
    timeout-minutes: 3600

    # 定义该任务的所有执行步骤，从上至下顺序执行，一步失败则全部终止
    steps:
      # 步骤1：拉取当前GitHub仓库的所有代码到云服务器的工作目录
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：配置Windows系统核心的RDP远程桌面基础服务和防火墙规则
      - name: Configure Core RDP Settings
        # 指定使用PowerShell核心执行脚本（Windows的原生脚本环境，必须指定）
        shell: pwsh
        # 运行仓库内的RDP配置脚本，开启RDP+放行3389端口+配置远程权限
        run: .github/workflows/scripts/win-configure-rdp.ps1

      # 步骤3：创建用于RDP远程登录的系统用户+生成高强度随机密码
      - name: Create RDP User with Secure Password
        shell: pwsh
        # 运行仓库内的用户创建脚本，核心修改：脚本内用户名已改为moti
        run: .github/workflows/scripts/win-create-user.ps1

      # 步骤4：在Windows Server 2016上静默安装Tailscale客户端
      - name: Install Tailscale
        shell: pwsh
        # 运行仓库内的Tailscale安装脚本，无弹窗静默安装适配Windows的版本
        run: .github/workflows/scripts/win-install-tailscale.ps1

      # 步骤5：使用密钥登录Tailscale组网，获取内网访问IP
      - name: Establish Tailscale Connection
        shell: pwsh
        # 注入环境变量：填写你的Tailscale认证密钥，直接明文填写即可
        env:
          TAILSCALE_AUTH_KEY: 填入你的 Tailscale Auth Key
        # 运行仓库内的Tailscale连接脚本，登录组网+获取IP并写入环境变量
        run: .github/workflows/scripts/win-establish-ts.ps1

      # 步骤6：校验RDP服务是否正常运行、3389端口是否监听、Tailscale网络是否连通
      - name: Verify RDP Accessibility
        shell: pwsh
        # 运行仓库内的校验脚本，检测失败则直接终止流程，避免无效运行
        run: .github/workflows/scripts/win-verify-rdp.ps1

      # 步骤7：输出远程连接的所有凭证+无限循环保活，防止任务终止
      - name: Maintain Connection
        shell: pwsh
        # 多行PowerShell命令，打印信息+永久保活
        run: |
          # 打印RDP连接信息的标题分隔符
          Write-Host "`n=== RDP ACCESS ==="
          # 打印远程连接地址：Tailscale分配的内网IP（RDP默认3389端口，无需拼接）
          Write-Host "Address: $env:TAILSCALE_IP"
          # 核心修改2：登录用户名 修改为 moti（全局生效）
          Write-Host "Username: moti"
          # 打印随机生成的登录密码，从环境变量中读取
          Write-Host "Password: $(echo $env:RDP_CREDS)"
          # 打印分隔符结束
          Write-Host "==================`n"
          # 无限循环，永久保活核心命令，阻止GitHub任务执行完毕后销毁服务器
          while ($true) {
            # 每隔5分钟打印一次运行状态，带当前时间戳
            Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
            # PowerShell休眠命令，休眠300秒=5分钟，再进入下一次循环
            Start-Sleep -Seconds 300
          }